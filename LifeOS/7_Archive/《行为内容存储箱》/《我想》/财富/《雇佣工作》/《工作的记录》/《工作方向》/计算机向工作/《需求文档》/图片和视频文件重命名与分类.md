### 需求文档：PowerShell 脚本 - 图片和视频文件重命名与分类

---

#### 1. 背景

在 Windows 文件夹中，存在多个子文件夹，其中包含大量由手机系统自动命名的图片和视频文件。这些文件的命名方式通常基于时间戳或其他系统生成的编码，不易于用户理解和识别。为了便于管理和查找，需要对这些文件进行重命名，并进一步按时间分类。

---

#### 2. 目标

- **重命名文件**：将图片和视频文件的名称从系统生成的编码格式改为更易理解的格式。
- **按时间分类**：将重命名后的文件按年份和月份分类到不同的文件夹中。

---

#### 3. 需求细节

##### 3.1 文件重命名

- **输入**：文件夹路径，包含多个子文件夹，子文件夹中包含图片和视频文件。
- **输出**：重命名后的文件，命名格式为 `YYYYMMDD_HHMMSS.Extension`，其中：
  - `YYYYMMDD` 表示文件的创建日期。
  - `HHMMSS` 表示文件的创建时间。
  - `Extension` 是文件的原始扩展名（如 `.jpg`, `.mp4` 等）。
- **处理逻辑**：
  - 遍历指定文件夹及其子文件夹中的所有图片和视频文件。
  - 从文件名中提取时间信息（`YYYYMMDD_HHMMSS`）。
  - 生成新的文件名并重命名文件。

##### 3.2 按时间分类

- **输入**：重命名后的文件。
- **输出**：按年份和月份分类的文件夹结构，例如：
  ```
  \目标文件夹
  ├── 2022
  │   ├── 06
  │   ├── 07
  │   └── ...
  ├── 2023
  │   ├── 01
  │   ├── 02
  │   └── ...
  └── ...
  ```
- **处理逻辑**：
  - 根据文件名中的时间信息，将文件移动到相应的年份和月份文件夹中。
  - 如果目标文件夹不存在，则自动创建。

##### 3.3 文件类型支持

- **图片文件**：`.jpg`, `.jpeg`, `.png`, `.gif`, `.bmp`, `.tiff`, `.webp` 等。
- **视频文件**：`.mp4`, `.mov`, `.avi`, `.mkv`, `.flv`, `.wmv` 等。

##### 3.4 错误处理

- 如果文件名冲突（例如，同一秒内创建了多个文件），在文件名后添加序号以区分，例如 `YYYYMMDD_HHMMSS_001.jpg`。
- 如果文件无法重命名或移动（例如，权限问题），记录错误并继续处理其他文件。

##### 3.5 日志记录

- 脚本应记录所有操作，包括重命名、移动文件、创建文件夹等。
- 日志文件应保存在指定路径，格式为 `YYYYMMDD_HHMMSS_FileRenameLog.txt`。

---

#### 4. 脚本输入参数

- `-SourcePath`：源文件夹路径，包含需要处理的图片和视频文件。
- `-DestinationPath`：目标文件夹路径，用于存放重命名和分类后的文件。
- `-LogPath`：日志文件保存路径（可选，默认为目标文件夹）。

---

#### 5. 示例

假设源文件夹结构如下：
```
E:\wjm2022\2022-2023
├── 子文件夹1
│   ├── VID_20220531_205329.mp4
│   ├── MVIMG_20220601_123456.jpg
├── 子文件夹2
│   ├── VID_20220715_182921.mp4
│   ├── MVIMG_20220820_221434.jpg
```

运行脚本后，目标文件夹结构如下：
```
E:\wjm2022\2022-2023
├── 2022
│   ├── 05
│   │   ├── 20220531_205329.mp4
│   ├── 06
│   │   ├── 20220601_123456.jpg
│   ├── 07
│   │   ├── 20220715_182921.mp4
│   ├── 08
│   │   ├── 20220820_221434.jpg
├── 20250109_154331_FileRenameLog.txt
```

---

#### 6. 脚本实现步骤

1. **遍历文件夹**：使用 `Get-ChildItem` 递归遍历源文件夹中的所有图片和视频文件。
2. **获取文件时间**：从文件名中提取时间信息（`YYYYMMDD_HHMMSS`）。
3. **重命名文件**：使用 `Rename-Item` 根据时间生成新文件名并重命名文件。
4. **创建分类文件夹**：使用 `New-Item` 创建年份和月份文件夹。
5. **移动文件**：使用 `Move-Item` 将文件移动到相应的分类文件夹。
6. **记录日志**：使用 `Out-File` 将操作记录到日志文件中。

---

#### 7. 注意事项

- **文件名格式**：确保文件名符合 `VID_YYYYMMDD_HHMMSS.mp4` 或 `MVIMG_YYYYMMDD_HHMMSS.jpg` 格式。
- **路径处理**：路径中包含空格或特殊字符时，需用双引号括起来。
- **权限问题**：确保脚本以管理员权限运行，并具有对目标文件夹的写入权限。
- **备份数据**：在运行脚本前，建议备份源文件夹中的数据，以防意外数据丢失。

---

#### 8. 后续扩展

- 支持更多文件类型。
- 添加用户交互功能，允许用户选择重命名和分类的规则。
- 添加进度条显示，提升用户体验。

---

### 更新后的 PowerShell 脚本

以下是更新后的脚本，满足上述需求：

```powershell
param (
    [string]$SourcePath = "E:\wjm2022\2022-2023",
    [string]$DestinationPath = "E:\wjm2022\2022-2023",
    [string]$LogPath = "E:\wjm2022\2022-2023"
)

# 设置编码为 UTF-8
$OutputEncoding = [System.Text.Encoding]::UTF8
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8

# 支持的图片和视频文件扩展名
$imageExtensions = @(".jpg", ".jpeg", ".png", ".gif", ".bmp", ".tiff", ".webp")
$videoExtensions = @(".mp4", ".mov", ".avi", ".mkv", ".flv", ".wmv")
$supportedExtensions = $imageExtensions + $videoExtensions

# 创建日志文件
$logFile = Join-Path $LogPath "$(Get-Date -Format 'yyyyMMdd_HHmmss')_FileRenameLog.txt"

# 确保日志文件夹存在
if (-not (Test-Path $LogPath)) {
    New-Item -Path $LogPath -ItemType Directory | Out-Null
}

# 写入日志
"Script started at $(Get-Date)" | Out-File -FilePath $logFile -Encoding UTF8

# 确保目标文件夹存在
if (-not (Test-Path $DestinationPath)) {
    New-Item -Path $DestinationPath -ItemType Directory | Out-Null
    "Created destination folder: $DestinationPath" | Out-File -FilePath $logFile -Encoding UTF8 -Append
}

# 检查源文件夹是否存在
if (-not (Test-Path $SourcePath)) {
    Write-Host "Source folder does not exist: $SourcePath"
    exit
}

# 打印源文件夹中的文件列表
Write-Host "Files in source folder:"
Get-ChildItem -Path $SourcePath -Recurse -File | ForEach-Object {
    Write-Host $_.FullName
}

# 遍历源文件夹中的所有文件
Get-ChildItem -Path $SourcePath -Recurse -File | ForEach-Object {
    try {
        $file = $_
        $fileName = $_.Name

        # 调试信息：打印当前处理的文件
        Write-Host "Processing file: $($file.FullName)"

        # 检查文件扩展名是否支持
        if ($supportedExtensions -contains $_.Extension) {
            # 从文件名中提取时间信息（格式：MVIMG_YYYYMMDD_HHMMSS.jpg 或 VID_YYYYMMDD_HHMMSS.mp4）
            if ($fileName -match "_(?<date>\d{8})_(?<time>\d{6})") {
                $date = $matches["date"]
                $time = $matches["time"]

                # 将日期字符串转换为 DateTime 对象
                try {
                    $dateTime = [datetime]::ParseExact($date, "yyyyMMdd", $null)
                    $yearFolder = $dateTime.ToString("yyyy")
                    $monthFolder = $dateTime.ToString("MM")  # 改为纯数字格式
                } catch {
                    Write-Host "Failed to parse date: $date"
                    continue
                }

                $newFileName = "$($date)_$($time)$($_.Extension)"
                # 使用 Join-Path 拼接路径
                $destinationFolder = Join-Path $DestinationPath $yearFolder
                $destinationFolder = Join-Path $destinationFolder $monthFolder

                # 创建目标文件夹
                if (-not (Test-Path $destinationFolder)) {
                    New-Item -Path $destinationFolder -ItemType Directory | Out-Null
                    "Created folder: $destinationFolder" | Out-File -FilePath $logFile -Encoding UTF8 -Append
                }

                # 处理文件名冲突
                $newFilePath = Join-Path $destinationFolder $newFileName
                $counter = 1
                while (Test-Path $newFilePath) {
                    $newFileName = "$($date)_$($time)_$($counter.ToString('D3'))$($_.Extension)"
                    $newFilePath = Join-Path $destinationFolder $newFileName
                    $counter++
                }

                # 调试信息：打印目标路径
                Write-Host "Generated destination path: $newFilePath"

                # 重命名并移动文件
                Move-Item -Path $file.FullName -Destination $newFilePath -Force
                "Moved and renamed: $($file.FullName) -> $newFilePath" | Out-File -FilePath $logFile -Encoding UTF8 -Append
            } else {
                Write-Host "File name does not match pattern: $fileName"
                "Skipped file (invalid name format): $($file.FullName)" | Out-File -FilePath $logFile -Encoding UTF8 -Append
            }
        } else {
            Write-Host "File extension not supported: $($_.Extension)"
            "Skipped file (unsupported extension): $($file.FullName)" | Out-File -FilePath $logFile -Encoding UTF8 -Append
        }
    } catch {
        Write-Host "Error processing file: $($file.FullName). Error: $_"
        "Error processing file: $($file.FullName). Error: $_" | Out-File -FilePath $logFile -Encoding UTF8 -Append
    }
}

"Script completed at $(Get-Date)" | Out-File -FilePath $logFile -Encoding UTF8 -Append
Write-Host "Script completed!"
```

---

### 使用方法

1. 将脚本保存为 `rename_files.ps1`。
2. 打开 PowerShell，运行脚本：
   ```powershell
   .\rename_files.ps1
   ```
3. 观察 PowerShell 窗口中的调试信息，确认脚本是否正常运行。
4. 检查日志文件（位于目标文件夹中），查看是否有错误记录。

---

### 后续步骤

- 如果需要对其他文件夹（如 `E:\wjm2022\redmi`）运行脚本，只需修改 `$SourcePath`、`$DestinationPath` 和 `$LogPath` 参数即可。
- 如果有其他需求或问题，请随时告诉我！

希望这份需求文档和脚本能满足您的需求！